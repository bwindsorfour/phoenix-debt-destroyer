<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Debt Destroyer - Automated Payoff Calculator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-field {
            /* Ensured explicit colors for dark mode visibility */
            @apply w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out;
            /* FORCED FIX: Overriding browser defaults for dark background/white text */
            background-color: #4A5568 !important; /* Tailwind gray-700 */
            color: #FFFFFF !important;
        }
        /* FORCED FIX: Placeholder text visibility */
        .input-field::placeholder {
            color: #A0AEC0 !important; /* Tailwind gray-400 */
        }
        .metric-card {
            @apply bg-gray-800 p-4 rounded-xl shadow-lg border-t-4 border-blue-500;
        }
        /* Custom scrollbar for debt list */
        .debt-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .debt-list-container::-webkit-scrollbar-thumb {
            background: #4A5568;
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-400">ðŸ”¥ Phoenix Debt Destroyer ðŸ”¥</h1>
            <p class="mt-2 text-xl text-gray-300">Automate your path to zero debt. High automation, zero guesswork.</p>
        </header>

        <!-- Main Grid Layout -->
        <main class="grid lg:grid-cols-3 gap-8">
            
            <!-- COLUMN 1: Debt Input Form -->
            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-2xl h-fit">
                <h2 class="text-2xl font-bold mb-6 text-blue-300">Add New Debt</h2>
                <form id="debt-form" class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-300 mb-1">Debt Name</label>
                        <input type="text" id="name" placeholder="e.g., Credit Card A" class="input-field" required>
                    </div>
                    <div>
                        <label for="balance" class="block text-sm font-medium text-gray-300 mb-1">Current Balance ($)</label>
                        <input type="number" id="balance" placeholder="2500.00" class="input-field" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label for="interest" class="block text-sm font-medium text-gray-300 mb-1">Interest Rate (APY, %)</label>
                        <input type="number" id="interest" placeholder="18.5" class="input-field" step="0.1" min="0" required>
                    </div>
                    <div>
                        <label for="minPayment" class="block text-sm font-medium text-gray-300 mb-1">Minimum Monthly Payment ($)</label>
                        <input type="number" id="minPayment" placeholder="50.00" class="input-field" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label for="extraPayment" class="block text-sm font-medium text-gray-300 mb-1">Extra Monthly Payment to Apply ($)</label>
                        <input type="number" id="extraPayment" value="0" class="input-field" step="0.01" min="0" required>
                    </div>
                    <!-- Added 'disabled' attribute here to prevent submission before auth is ready -->
                    <button type="submit" id="submit-debt-btn" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg rounded-xl transition duration-150 ease-in-out shadow-lg shadow-blue-500/50" disabled>
                        Add Debt
                    </button>
                </form>
            </div>

            <!-- COLUMN 2: Debt List & Control -->
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl">
                    <h2 class="text-2xl font-bold mb-4 text-blue-300">Your Debts (Real-Time Storage)</h2>
                    <p id="auth-status" class="text-sm text-yellow-500 mb-4">Initializing Firebase...</p>
                    <div id="debt-list" class="debt-list-container max-h-80 overflow-y-auto space-y-3">
                        <!-- Debts will be rendered here -->
                        <p id="no-debts" class="text-gray-400">No debts added yet. Use the form to the left!</p>
                    </div>
                </div>

                <!-- COLUMN 2: Dashboard Controls -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl">
                    <h2 class="text-2xl font-bold mb-4 text-blue-300">Payoff Strategy & Results</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <button id="snowball-btn" class="w-full sm:w-1/2 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition duration-150 ease-in-out shadow-md shadow-red-500/50">
                            Apply Debt Snowball (Low-to-High Balance)
                        </button>
                        <button id="avalanche-btn" class="w-full sm:w-1/2 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl transition duration-150 ease-in-out shadow-md shadow-green-500/50">
                            Apply Debt Avalanche (High-to-Low Interest)
                        </button>
                    </div>

                    <!-- Calculation Output -->
                    <div id="results-dashboard" class="mt-8 space-y-6">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="metric-card">
                                <p class="text-sm text-gray-400">Strategy Selected</p>
                                <p id="strategy-name" class="text-2xl font-bold text-yellow-300 mt-1" data-active-method="">None</p>
                            </div>
                            <div class="metric-card">
                                <p class="text-sm text-gray-400">Estimated Payoff Date</p>
                                <p id="payoff-date" class="text-2xl font-bold text-blue-300 mt-1">N/A</p>
                            </div>
                            <div class="metric-card">
                                <p class="text-sm text-gray-400">Total Interest Paid</p>
                                <p id="total-interest" class="text-2xl font-bold text-red-400 mt-1">N/A</p>
                            </div>
                        </div>

                        <div class="bg-gray-700 p-4 rounded-lg">
                            <p class="text-lg font-semibold text-gray-200">Total Debt Burden</p>
                            <p id="total-debt" class="text-3xl font-extrabold text-white mt-1">$0.00</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Debugging/User Info Section -->
        <footer class="mt-10 text-center text-xs text-gray-500">
            <p>App ID: <span id="app-id-display"></span> | User ID: <span id="user-id-display"></span></p>
            <p class="mt-2">Data is stored securely in your private Firestore collection.</p>
        </footer>
    </div>

    <!-- Firebase SDK Imports (MUST BE BEFORE script tag) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Set Firebase Log Level for debugging
        setLogLevel('debug');

        // --- DYNAMIC VARIABLE INJECTION FOR NETLIFY ---
        // This script block checks for Node/Netlify environment variables (which are not naturally exposed in static HTML)
        // and defines them globally so the main script can access them.
        
        // These are intentionally empty strings to be replaced by Netlify's build process if defined.
        window.VITE_FIREBASE_API_KEY = window.VITE_FIREBASE_API_KEY || '';
        window.VITE_FIREBASE_AUTH_DOMAIN = window.VITE_FIREBASE_AUTH_DOMAIN || '';
        window.VITE_FIREBASE_PROJECT_ID = window.VITE_FIREBASE_PROJECT_ID || '';
        window.VITE_FIREBASE_APP_ID = window.VITE_FIREBASE_APP_ID || '';
        window.VITE_APP_ID_FOR_FIRESTORE = window.VITE_APP_ID_FOR_FIRESTORE || '';

        // --- GLOBAL SETUP VARIABLES (Handles Canvas environment and Netlify environment) ---
        // 1. Check for Canvas variables first
        const isCanvas = typeof __firebase_config !== 'undefined';
        const canvasAppId = isCanvas ? __app_id : 'default-app-id';
        const canvasFirebaseConfig = isCanvas ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = isCanvas ? __initial_auth_token : null;

        // 2. Fallback to Netlify/Vercel Environment Variables (read from window object)
        const netlifyConfig = {
            apiKey: window.VITE_FIREBASE_API_KEY,
            authDomain: window.VITE_FIREBASE_AUTH_DOMAIN,
            projectId: window.VITE_FIREBASE_PROJECT_ID,
            appId: window.VITE_FIREBASE_APP_ID,
        };
        const netlifyAppId = window.VITE_APP_ID_FOR_FIRESTORE;

        // 3. Determine Final Config Source
        let finalFirebaseConfig = {};
        let appId = canvasAppId;

        if (isCanvas && Object.keys(canvasFirebaseConfig).length > 0) {
            // Use Canvas config
            finalFirebaseConfig = canvasFirebaseConfig;
            appId = canvasAppId;
        } else if (netlifyConfig.apiKey) {
            // Use Netlify config (assuming VITE_FIREBASE_API_KEY is defined)
            finalFirebaseConfig = netlifyConfig;
            appId = netlifyAppId || netlifyConfig.projectId; // Use VITE_APP_ID_FOR_FIRESTORE if available, otherwise Project ID
        } else {
            // Neither environment provided valid config
            console.warn("No valid Firebase configuration found in environment variables.");
        }


        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let debts = [];
        
        const submitButton = document.getElementById('submit-debt-btn');
        const authStatusElement = document.getElementById('auth-status');

        // Utility Function to format currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(amount);
        };

        // Utility Function to format date as Month Year
        const formatDate = (date) => {
            return new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'long' }).format(date);
        };
        
        // Utility Function to convert date string to Date object
        const parseDate = (dateString) => {
            const [month, year] = dateString.split(' ');
            const monthIndex = new Date(Date.parse(month + " 1, 2012")).getMonth();
            return new Date(year, monthIndex);
        }

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        const initFirebase = async () => {
            try {
                document.getElementById('app-id-display').textContent = appId;
                
                // CRUCIAL: Check if finalFirebaseConfig is actually valid before initializing
                if (!finalFirebaseConfig || Object.keys(finalFirebaseConfig).length === 0 || !finalFirebaseConfig.apiKey) {
                    throw new Error("Firebase configuration object is missing or invalid. Deployment environment keys (VITE_...) must be set.");
                }

                app = initializeApp(finalFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Handle initial authentication status
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        // Enable the form and clear status once ready
                        isAuthReady = true;
                        submitButton.disabled = false;
                        authStatusElement.textContent = `Authenticated. User ID: ${userId}`;
                        authStatusElement.classList.replace('text-yellow-500', 'text-green-500');
                        startDebtListener();
                    } else {
                        // Attempt sign in
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                // Display more descriptive error to the user
                authStatusElement.textContent = `Error initializing Firebase. Check configuration/network.`;
                authStatusElement.classList.replace('text-yellow-500', 'text-red-500');
            }
        };

        // --- FIRESTORE DATA FUNCTIONS ---

        const getCollectionRef = () => {
            if (!userId) throw new Error("User not authenticated.");
            // Private data path: /artifacts/{appId}/users/{userId}/{collectionName}
            return collection(db, 'artifacts', appId, 'users', userId, 'debts');
        };

        const startDebtListener = () => {
            if (!isAuthReady || !userId) return;

            const debtsRef = getCollectionRef();
            // Note: Not using orderBy() to avoid needing extra indexes, sorting will be done locally.
            onSnapshot(debtsRef, (snapshot) => {
                debts = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    debts.push({
                        id: doc.id,
                        name: data.name,
                        balance: parseFloat(data.balance),
                        interestRate: parseFloat(data.interestRate),
                        minPayment: parseFloat(data.minPayment),
                        extraPayment: parseFloat(data.extraPayment || 0),
                    });
                });
                renderDebtList();
                calculateAndDisplayResults(); // Recalculate anytime debt data changes
            }, (error) => {
                console.error("Error listening to debts:", error);
                authStatusElement.textContent = `Error syncing data. See console.`;
            });
        };

        const addDebt = async (debt) => {
            try {
                await addDoc(getCollectionRef(), debt);
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        };

        const deleteDebt = async (id) => {
            try {
                await deleteDoc(doc(getCollectionRef(), id));
            } catch (error) {
                console.error("Error deleting document: ", error);
            }
        };
        
        // --- DEBT PAYOFF LOGIC (CORE ENGINE) ---

        /**
         * Calculates payoff for multiple debts using Snowball or Avalanche method.
         * @param {string} method - 'snowball' or 'avalanche'.
         * @param {number} extraPayment - Extra money allocated to be added to the target debt.
         * @returns {{payoffDate: string, totalInterest: number, method: string}}
         */
        const calculateStrategyPayoff = (method, extraPayment) => {
            if (debts.length === 0) return { payoffDate: 'N/A', totalInterest: 0, method: 'None' };

            // 1. Prepare and Sort Debts
            let debtList = JSON.parse(JSON.stringify(debts)); // Deep copy
            debtList.forEach(d => { d.interestRate /= 100; }); // Convert % to decimal

            if (method === 'snowball') {
                // Snowball: Lowest balance first
                debtList.sort((a, b) => a.balance - b.balance);
            } else if (method === 'avalanche') {
                // Avalanche: Highest interest rate first
                debtList.sort((a, b) => b.interestRate - a.interestRate);
            }
            
            // 2. Initialize Variables
            let currentExtraPayment = extraPayment; // This "snowball" will grow
            let currentDate = new Date();
            let totalInterestPaid = 0;
            let activeDebts = debtList.map(d => ({ ...d, currentBalance: d.balance }));

            let monthCounter = 0;
            const maxMonths = 1200; // Safety break

            // 3. Main Payoff Loop
            while (activeDebts.some(d => d.currentBalance > 0) && monthCounter < maxMonths) {
                monthCounter++;
                currentDate.setMonth(currentDate.getMonth() + 1);

                // Find the target debt (the first one still active, based on sorted order)
                const targetDebtIndex = activeDebts.findIndex(d => d.currentBalance > 0);
                
                if (targetDebtIndex === -1) break; // All paid off
                
                // Monthly payment allocation
                for (let i = 0; i < activeDebts.length; i++) {
                    let debt = activeDebts[i];
                    if (debt.currentBalance <= 0) continue;
                    
                    const monthlyRate = debt.interestRate / 12;
                    const interestPayment = debt.currentBalance * monthlyRate;
                    totalInterestPaid += interestPayment;

                    let payment = debt.minPayment;
                    
                    // If this is the current target debt, add the growing extra payment
                    if (i === targetDebtIndex) {
                        payment += currentExtraPayment;
                    }

                    // Determine the amount to pay towards principal
                    let principalPayment = payment - interestPayment;

                    if (debt.currentBalance + interestPayment <= payment) {
                        // Payoff month: Pay exactly the remaining balance + interest
                        principalPayment = debt.currentBalance;
                        debt.currentBalance = 0;
                        
                        // If paid off, add the debt's minimum payment to the growing extra payment (the "snowball" grows)
                        currentExtraPayment += debt.minPayment;
                        
                    } else {
                        // Standard payment month
                        debt.currentBalance -= principalPayment;
                    }
                }
            }

            return { 
                payoffDate: activeDebts.every(d => d.currentBalance <= 0) ? formatDate(currentDate) : 'Over 100 years', 
                totalInterest: totalInterestPaid, 
                method: method === 'snowball' ? 'Debt Snowball' : 'Debt Avalanche'
            };
        };

        // --- UI RENDERING & EVENT HANDLERS ---
        
        const renderDebtList = () => {
            const listContainer = document.getElementById('debt-list');
            listContainer.innerHTML = '';
            
            if (debts.length === 0) {
                listContainer.innerHTML = '<p id="no-debts" class="text-gray-400">No debts added yet. Use the form to the left!</p>';
                document.getElementById('total-debt').textContent = formatCurrency(0);
                return;
            }

            let totalDebtBalance = 0;

            debts.forEach(debt => {
                totalDebtBalance += debt.balance;
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center transition duration-150 ease-in-out hover:bg-gray-600';
                div.innerHTML = `
                    <div>
                        <p class="text-lg font-semibold text-white">${debt.name}</p>
                        <p class="text-sm text-gray-300">Balance: ${formatCurrency(debt.balance)} | Rate: ${debt.interestRate.toFixed(2)}% | Min Pay: ${formatCurrency(debt.minPayment)}</p>
                    </div>
                    <button data-id="${debt.id}" class="delete-btn text-red-400 hover:text-red-500 font-bold ml-4 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m1.23-7.5l-3.085 2.5a.5.5 0 00-.017.067L6 7l-2 11h16L18 7l-.017-.067A.5.5 0 0014.74 9z" />
                        </svg>
                    </button>
                `;
                listContainer.appendChild(div);
            });

            document.getElementById('total-debt').textContent = formatCurrency(totalDebtBalance);
            
            // Add event listeners for delete buttons
            listContainer.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    deleteDoc(doc(getCollectionRef(), id)).catch(error => {
                        console.error("Error deleting document: ", error);
                    });
                });
            });
        };
        
        const calculateAndDisplayResults = (method = null) => {
            const extraPaymentInput = document.getElementById('extraPayment');
            const extraPaymentValue = parseFloat(extraPaymentInput.value) || 0;
            
            let strategy = { payoffDate: 'N/A', totalInterest: 0, method: 'None Selected' };

            // Determine which button was last clicked, or if we have results to display
            // Use the data-active-method attribute for persistence between data loads
            const activeMethod = method || document.getElementById('strategy-name').dataset.activeMethod;
            
            if (debts.length === 0) {
                 // Nothing to calculate
                 document.getElementById('strategy-name').dataset.activeMethod = ''; // Clear active method
                 strategy.payoffDate = 'N/A';
                 strategy.totalInterest = 0;
                 strategy.method = 'None';
            } else if (activeMethod && activeMethod !== 'None') {
                // Explicit Snowball or Avalanche click
                strategy = calculateStrategyPayoff(activeMethod, extraPaymentValue);
                document.getElementById('strategy-name').dataset.activeMethod = activeMethod;
            } else {
                // Initial load or data change: show Minimum Payment Baseline
                // We use 'avalanche' with 0 extra payment; the result is the same as minimum payments only.
                const baseline = calculateStrategyPayoff('avalanche', 0); 
                strategy.payoffDate = baseline.payoffDate; 
                strategy.totalInterest = baseline.totalInterest;
                strategy.method = 'Minimum Payment Only (Baseline)';
            }

            // Update UI
            document.getElementById('strategy-name').textContent = strategy.method;
            document.getElementById('payoff-date').textContent = strategy.payoffDate;
            document.getElementById('total-interest').textContent = formatCurrency(strategy.totalInterest);
        };


        // --- MAIN APPLICATION SETUP ---

        document.getElementById('debt-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check auth status before proceeding
            if (!isAuthReady) {
                 // The button is disabled, but if a user somehow bypasses, this ensures safety.
                 authStatusElement.textContent = 'Please wait, still signing in...';
                 return;
            }

            const newDebt = {
                name: document.getElementById('name').value,
                balance: document.getElementById('balance').value,
                interestRate: document.getElementById('interest').value,
                minPayment: document.getElementById('minPayment').value,
                extraPayment: document.getElementById('extraPayment').value || '0',
            };

            // Basic validation check
            if (parseFloat(newDebt.balance) <= 0 || parseFloat(newDebt.interestRate) < 0 || parseFloat(newDebt.minPayment) <= 0) {
                console.error("Please enter valid positive numbers for Balance and Minimum Payment. Interest Rate can be 0 or positive.");
                return;
            }

            try {
                await addDoc(getCollectionRef(), newDebt);
                e.target.reset(); // Clear form after successful submission
                document.getElementById('extraPayment').value = 0; // Resetting value
            } catch (error) {
                console.error("Error adding debt:", error);
                authStatusElement.textContent = 'Failed to save debt. Check console.';
            }
        });

        document.getElementById('snowball-btn').addEventListener('click', () => {
            calculateAndDisplayResults('snowball');
        });

        document.getElementById('avalanche-btn').addEventListener('click', () => {
            calculateAndDisplayResults('avalanche');
        });
        
        // Initial setup
        initFirebase();
    </script>
</body>
</html>
